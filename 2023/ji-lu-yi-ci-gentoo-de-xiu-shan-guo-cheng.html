<!doctype html><title>
记录一次 Gentoo 的修缮过程
    </title><meta charset=utf-8><meta content=width=device-width initial-scale=1 name=viewport><link href=/theme/css/main.css rel=stylesheet><body><h1>记录一次 Gentoo 的修缮过程</h1> 2023-04-29 13:29 <hr><div class="contents topic" id=topic-1><p class=topic-title><a class="reference internal" href=#top>目录</a><ul class=simple><li><a class="reference internal" href=#abstract id=toc-entry-1>0. abstract</a><li><a class="reference internal" href=#livecd id=toc-entry-2>1. livecd</a><ul><li><a class="reference internal" href=#mount id=toc-entry-3>1.1. mount</a><li><a class="reference internal" href=#stage3 id=toc-entry-4>1.2. stage3</a><li><a class="reference internal" href=#base id=toc-entry-5>1.3. base</a></ul><li><a class="reference internal" href=#btrfs-for-safety id=toc-entry-6>2. Btrfs for safety</a><ul><li><a class="reference internal" href=#section-1 id=toc-entry-7>2.1. 清理碎片</a><li><a class="reference internal" href=#section-2 id=toc-entry-8>2.2. 子卷快照</a></ul></ul></div><div class=section id=abstract><h2><a class=toc-backref href=#toc-entry-1>0. abstract</a></h2><p>最近在 /etc/fstab 里面指定 /var/lib/docker 时出现了失误，致使我的 root 分区被污染，重新修复 seems implausible，于是痛定思痛重装 Gentoo，同时记录一下。</div><div class=section id=livecd><h2><a class=toc-backref href=#toc-entry-2>1. livecd</a></h2><div class=section id=mount><h3><a class=toc-backref href=#toc-entry-3>1.1. mount</a></h3><p>即使 Gentoo 多年，由于我总是在 grub 保有 recovery entry，所以进 livecd 抢救的次数也屈指可数，这使我总是忘记这段关键的命令<div class=highlight><pre><span></span>sudo<span class=w> </span>mkdir<span class=w> </span>/mnt/gentoo
sudo<span class=w> </span>mount<span class=w> </span>-vo<span class=w> </span>compress-force<span class=o>=</span>zstd,subvolid<span class=o>=</span><span class=m>256</span><span class=w> </span>/dev/nvme0n1p3<span class=w> </span>/mnt/gentoo
sudo<span class=w> </span>mount<span class=w> </span>-vo<span class=w> </span>compress-force<span class=o>=</span>zstd,subvolid<span class=o>=</span><span class=m>257</span><span class=w> </span>/dev/nvme0n1p3<span class=w> </span>/mnt/gentoo/home
sudo<span class=w> </span>mount<span class=w> </span>/dev/nvme0n1p1<span class=w> </span>/mnt/gentoo/boot
sudo<span class=w> </span>swapon<span class=w> </span>/dev/nvme0n1p2
sudo<span class=w> </span>mount<span class=w> </span>--types<span class=w> </span>proc<span class=w> </span>/proc<span class=w> </span>/mnt/gentoo/proc
<span class=k>for</span><span class=w> </span>i<span class=w> </span><span class=k>in</span><span class=w> </span>sys<span class=w> </span>dev<span class=w> </span>run<span class=p>;</span><span class=w> </span><span class=k>do</span>
<span class=k>for</span><span class=w> </span>><span class=w> </span>sudo<span class=w> </span>mount<span class=w> </span>--rbind<span class=w> </span>/<span class=nv>$i</span><span class=w> </span>/mnt/gentoo/<span class=nv>$i</span>
<span class=k>for</span><span class=w> </span>><span class=w> </span>sudo<span class=w> </span>mount<span class=w> </span>--make-rslave<span class=w> </span>/mnt/gentoo/<span class=nv>$i</span>
<span class=k>done</span>
</pre></div></div><div class=section id=stage3><h3><a class=toc-backref href=#toc-entry-4>1.2. stage3</a></h3><p>下载 stage3 之前最重要的事，which I often forget，就是校准时间<div class=highlight><pre><span></span>sudo<span class=w> </span>date<span class=w> </span><span class=m>042914362023</span><span class=w> </span><span class=c1># 将时间设定为 04月29日，14：36，2023年</span>
</pre></div><p>另一个就是保留权限解压 tar 包<div class=highlight><pre><span></span>tar<span class=w> </span>xfpv<span class=w> </span>stage3-*.tar.xz<span class=w> </span>--xattrs-include<span class=o>=</span><span class=s1>'*.*'</span><span class=w> </span>--numeric-owner
</pre></div></div><div class=section id=base><h3><a class=toc-backref href=#toc-entry-5>1.3. base</a></h3><p>拷贝 dns 信息<div class=highlight><pre><span></span>cp<span class=w> </span>--dereference<span class=w> </span>/etc/resolv.conf<span class=w> </span>/mnt/gentoo/etc/
</pre></div><p>以及gentoo 仓库的信息<div class=highlight><pre><span></span>mkdir<span class=w> </span>/mnt/gentoo/etc/portage/repos.conf
cp<span class=w> </span>/mnt/gentoo/usr/share/portage/config/repos.conf<span class=w> </span>/mnt/gentoo/etc/portage/repos.conf/gentoo.conf
</pre></div><p>或许在 /etc/portage/repos.conf/gentoo.conf 里面可以加上 <strong>sync-openpgp-key-refresh = no</strong></div></div><div class=section id=btrfs-for-safety><h2><a class=toc-backref href=#toc-entry-6>2. Btrfs for safety</a></h2><p>前面其实都是些废话，最重要的就是好好利用 <strong>Copy on Write, CoW</strong> 和 <strong>snapshot</strong> 特性，empowered by Btrfs<div class=section id=section-1><h3><a class=toc-backref href=#toc-entry-7>2.1. 清理碎片</a></h3><p>谨记，Btrfs 命令支持 <em>最短去重前缀</em><div class=highlight><pre><span></span><span class=c1># btrfs filesystem defragment -v /</span>
<span class=c1># btrfs fi de -v /  # 以上命令可以写成这样</span>
</pre></div></div><div class=section id=section-2><h3><a class=toc-backref href=#toc-entry-8>2.2. 子卷快照</a></h3><p>Btrfs 的子卷并不是块设备，而是独立可挂载的 POSIX filetree<div class=highlight><pre><span></span><span class=c1># btrfs subvolume snapshot &LTsubvolume> { &LTsubdir>/&LTname> | &LTsubdir> }</span>
<span class=c1># btrfs sub snap -r ... # -r 意味着该快照只读</span>
</pre></div><p>首先在 / 下创建专用于备份的文件夹，我称其为 <em>snapshoot</em> 哈哈哈<div class=highlight><pre><span></span><span class=c1># btrfs subvolume create /snapshoot</span>
</pre></div><p>我将 home 文件夹设为了子卷，所以需要快照两次，因为 btrfs 的快照 <strong>不是递归的</strong> ， 子卷存在的地方会被映射为同名的空文件夹<div class=highlight><pre><span></span><span class=c1># btrfs subvolume snapshot -r /     /snapshoot/$(date +"%Y-%m-%d")-readonly-root</span>
<span class=c1># btrfs subvolume snapshot -r /home /snapshoot/$(date +"%Y-%m-%d")-readonly-home</span>
</pre></div></div></div>