<!DOCTYPE html><html> <head><title>deploy darknet with CUDA and OpenCV support on Arch Linux</title><meta charset=utf-8><link rel=stylesheet href=/theme/css/main.css></head> <body> <h1>deploy darknet with CUDA and OpenCV support on Arch Linux</h1> 2020-09-03 20:55 <hr> <p><img alt="predicted image" src=/files/deploy-darknet-with-CUDA-and-OpenCV-support/predictions.jpg></p> <h1>0. abstract</h1> <p>Despite the fact that using <a href=https://pjreddie.com/darknet/ >darknet</a> is rather simple, there are still some points to focus on.</p> <h1>1. install the base</h1> <div class=highlight><pre><span></span><code>git<span class=w> </span>clone<span class=w> </span>https://github.com/pjreddie/darknet.git
<span class=nb>cd</span><span class=w> </span>darknet
make
</code></pre></div> <p>It is possibile to run several jobs simultaenously if your system is multi-core/multi-processor. The easiest way to check the number of cores is <code>nproc --all</code> or <code>cat /proc/cpuinfo</code>, <code>lscpu</code> is also feasible.</p> <div class=highlight><pre><span></span><code>make<span class=w> </span>-j<span class=k>$(</span>nproc<span class=k>)</span>
</code></pre></div> <p>Once compiled, the binary file is executed as below:</p> <div class=highlight><pre><span></span><code>./darknet
</code></pre></div> <h1>2. compile with CUDA</h1> <p>Change the first line of <em>Makefile</em> into <code>GPU=1</code>, then change the content in brackets &lt;...&gt; listed below:</p> <div class=highlight><pre><span></span><code><span class=cp>ifeq ($(GPU), 1) </span>
<span class=nv>COMMON</span><span class=o>+=</span><span class=w> </span>-DGPU<span class=w> </span>-I<span class=w> </span>&lt;...&gt;
<span class=nv>CFLAGS</span><span class=o>+=</span><span class=w> </span>-DGPU
<span class=nv>LDFLAGS</span><span class=o>+=</span><span class=w> </span>-L&lt;...&gt;<span class=w> </span>-lcuda<span class=w> </span>-lcudart<span class=w> </span>-lcublas<span class=w> </span>-lcurand
<span class=cp>endif</span>
</code></pre></div> <p>For instance, the default instll folder of CUDA on Arch Linux is <code>/opt/cuda</code></p> <div class=highlight><pre><span></span><code><span class=cp>ifeq ($(GPU), 1) </span>
<span class=nv>COMMON</span><span class=o>+=</span><span class=w> </span>-DGPU<span class=w> </span>-I<span class=w> </span>/opt/cuda/include
<span class=nv>CFLAGS</span><span class=o>+=</span><span class=w> </span>-DGPU
<span class=nv>LDFLAGS</span><span class=o>+=</span><span class=w> </span>-L/opt/cuda/lib64<span class=w> </span>-lcuda<span class=w> </span>-lcudart<span class=w> </span>-lcublas<span class=w> </span>-lcurand
<span class=cp>endif</span>
</code></pre></div> <p>Then we need to look up the <a href=https://docs.nvidia.com/cuda/cuda-c-programming-guide/index.html#compute-capability>compute capability</a> of our GPU <a href=https://developer.nvidia.com/en/cuda-gpus>here</a>.</p> <p>For instance, my GPU, <em>NVIDIA GeForece MX130</em>, is not listed in the form. ~~According to some articles, however, this card is exactly the same as <em>GeForce 940MX</em>, the compute capability of which, in that form, is 5.0.~~ According to <a href=https://en.wikipedia.org/wiki/CUDA>wikipedia</a>, the compute capability is exactly 6.1</p> <p>Therefore, we need to change the architecture in <em>Makefile</em> for <a href=https://docs.nvidia.com/deploy/cuda-compatibility/index.html#toolkit-versioning>cuda compatibility</a>.</p> <p>In detail, change both the code to ten times of your compute capability, which is 61 for me.</p> <div class=highlight><pre><span></span><code># before
ARCH= -gencode arch=compute_30,code=sm_30 \
      -gencode arch=compute_35,code=sm_35 \
      -gencode arch=compute_50,code=[sm_50,compute_50] \
      -gencode arch=compute_52,code=[sm_52,compute_52]
      #-gencode arch=compute_20,code=[sm_20,sm_21] \ This one is deprecated?

# after
ARCH= -gencode arch=compute_61,code=sm_61 \
      -gencode arch=compute_35,code=sm_35 \
      -gencode arch=compute_50,code=[sm_50,compute_50] \
      -gencode arch=compute_52,code=[sm_52,compute_52]
      #-gencode arch=compute_20,code=[sm_20,sm_21] \ This one is deprecated?
</code></pre></div> <p>After that we can compile it again using <code>make -j$(nproc)</code>, and render darket with CUDA support.</p> <p><a href=https://pjreddie.com/media/files/yolov3.weights>Yolov3.weights</a> downloaded, you can detect object in a rather good speed as followed:</p> <div class=highlight><pre><span></span><code>./darknet<span class=w> </span>detect<span class=w> </span>cfg/yolov3.cfg<span class=w> </span>yolov3.weights<span class=w> </span>data/dog.jpg
</code></pre></div> <h1>3. OpenCV support</h1> <p>By default darknet does not support OpenCV, which means you have to manually open the predicted picture generated in the folder.</p> <p>Just open <em>Makefile</em> and enable it:</p> <div class=highlight><pre><span></span><code>OPENCV=1
</code></pre></div> <p>Notice that the dependency name of package<code>opencv</code> in Arch Linux is <strong>opencv4</strong>. You can have a test by <code>pkg-config --libs opencv4</code>.</p> <div class=highlight><pre><span></span><code><span class=c># before</span>
<span class=cp>ifeq ($(OPENCV), 1) </span>
<span class=nv>COMMON</span><span class=o>+=</span><span class=w> </span>-DOPENCV
<span class=nv>CFLAGS</span><span class=o>+=</span><span class=w> </span>-DOPENCV
<span class=nv>LDFLAGS</span><span class=o>+=</span><span class=w> </span><span class=sb>`</span>pkg-config<span class=w> </span>--libs<span class=w> </span>opencv<span class=sb>`</span><span class=w> </span>-lstdc++
<span class=nv>COMMON</span><span class=o>+=</span><span class=w> </span><span class=sb>`</span>pkg-config<span class=w> </span>--cflags<span class=w> </span>opencv<span class=sb>`</span>
<span class=cp>endif</span>

<span class=c># after</span>
<span class=cp>ifeq ($(OPENCV), 1) </span>
<span class=nv>COMMON</span><span class=o>+=</span><span class=w> </span>-DOPENCV
<span class=nv>CFLAGS</span><span class=o>+=</span><span class=w> </span>-DOPENCV
<span class=nv>LDFLAGS</span><span class=o>+=</span><span class=w> </span><span class=sb>`</span>pkg-config<span class=w> </span>--libs<span class=w> </span>opencv4<span class=sb>`</span><span class=w> </span>-lstdc++
<span class=nv>COMMON</span><span class=o>+=</span><span class=w> </span><span class=sb>`</span>pkg-config<span class=w> </span>--cflags<span class=w> </span>opencv4<span class=sb>`</span>
<span class=cp>endif</span>
</code></pre></div> <p>When we've happily modified the pkg-config and expected it to compile successfully, things happened: life is hard.</p> <p>The compilation went error with</p> <div class=highlight><pre><span></span><code><span class=p>.</span><span class=o>/</span><span class=nx>src</span><span class=o>/</span><span class=nx>image_opencv</span><span class=p>.</span><span class=nx>cpp</span><span class=p>:</span><span class=mi>12</span><span class=p>:</span><span class=mi>1</span><span class=p>:</span><span class=w> </span><span class=nx>error</span><span class=p>:</span><span class=w> </span><span class=err>‘</span><span class=nx>IplImage</span><span class=err>’</span><span class=w> </span><span class=nx>does</span><span class=w> </span><span class=k>not</span><span class=w> </span><span class=nx>name</span><span class=w> </span><span class=nx>a</span><span class=w> </span><span class=k>type</span>
<span class=w>   </span><span class=mi>12</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=nx>IplImage</span><span class=w> </span><span class=o>*</span><span class=nx>image_to_ipl</span><span class=p>(</span><span class=nx>image</span><span class=w> </span><span class=nx>im</span><span class=p>)</span>
<span class=w>      </span><span class=o>|</span><span class=w> </span><span class=o>^~~~~~~~</span>
<span class=nx>compilation</span><span class=w> </span><span class=nx>terminated</span><span class=w> </span><span class=nx>due</span><span class=w> </span><span class=nx>to</span><span class=w> </span><span class=o>-</span><span class=nx>Wfatal</span><span class=o>-</span><span class=nx>errors</span><span class=p>.</span>
<span class=nx>make</span><span class=p>:</span><span class=w> </span><span class=o>***</span><span class=w> </span><span class=p>[</span><span class=nx>Makefile</span><span class=p>:</span><span class=mi>86</span><span class=p>:</span><span class=w> </span><span class=nx>obj</span><span class=o>/</span><span class=nx>image_opencv</span><span class=p>.</span><span class=nx>o</span><span class=p>]</span><span class=w> </span><span class=nx>Error</span><span class=w> </span><span class=mi>1</span>
<span class=nx>make</span><span class=p>:</span><span class=w> </span><span class=o>***</span><span class=w> </span><span class=nx>Waiting</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=nx>unfinished</span><span class=w> </span><span class=nx>jobs</span><span class=o>...</span><span class=p>.</span>
</code></pre></div> <p>Some C APIs, which have been deprecated for a long time, were removed from the lateset OpenCV release. The solution is to remove references to the C APIs and use C++ API or to re-include the old C APIs from the OpenCV legacies.</p> <p>Open src/image_opencv.cpp</p> <div class=highlight><pre><span></span><code><span class=cp>#include</span><span class=w> </span><span class=cpf>&quot;opencv2/imgproc/imgproc_c.h&quot;</span>
</code></pre></div> <p>and change <code>IplImage ipl = m</code> in function <code>mat_to_image(Mat m)</code> to</p> <div class=highlight><pre><span></span><code><span class=n>IplImage</span><span class=w> </span><span class=n>ipl</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>cvIplImage</span><span class=p>(</span><span class=n>m</span><span class=p>)</span>
</code></pre></div> <p>also, in the function <code>*void_video_stream(...)</code></p> <div class=highlight><pre><span></span><code><span class=c1>// before</span>
<span class=k>if</span><span class=p>(</span><span class=n>w</span><span class=p>)</span><span class=w> </span><span class=n>cap</span><span class=o>-&gt;</span><span class=n>set</span><span class=p>(</span><span class=n>CV_CAP_PROP_FRAME_WIDTH</span><span class=p>,</span><span class=w> </span><span class=n>w</span><span class=p>);</span>
<span class=k>if</span><span class=p>(</span><span class=n>h</span><span class=p>)</span><span class=w> </span><span class=n>cap</span><span class=o>-&gt;</span><span class=n>set</span><span class=p>(</span><span class=n>CV_CAP_PROP_FRAME_HEIGHT</span><span class=p>,</span><span class=w> </span><span class=n>w</span><span class=p>);</span>
<span class=k>if</span><span class=p>(</span><span class=n>fps</span><span class=p>)</span><span class=w> </span><span class=n>cap</span><span class=o>-&gt;</span><span class=n>set</span><span class=p>(</span><span class=n>CV_CAP_PROP_FPS</span><span class=p>,</span><span class=w> </span><span class=n>w</span><span class=p>);</span>

<span class=c1>// after</span>
<span class=k>if</span><span class=p>(</span><span class=n>w</span><span class=p>)</span><span class=w> </span><span class=n>cap</span><span class=o>-&gt;</span><span class=n>set</span><span class=p>(</span><span class=n>CAP_PROP_FRAME_WIDTH</span><span class=p>,</span><span class=w> </span><span class=n>w</span><span class=p>);</span>
<span class=k>if</span><span class=p>(</span><span class=n>h</span><span class=p>)</span><span class=w> </span><span class=n>cap</span><span class=o>-&gt;</span><span class=n>set</span><span class=p>(</span><span class=n>CAP_PROP_FRAME_HEIGHT</span><span class=p>,</span><span class=w> </span><span class=n>w</span><span class=p>);</span>
<span class=k>if</span><span class=p>(</span><span class=n>fps</span><span class=p>)</span><span class=w> </span><span class=n>cap</span><span class=o>-&gt;</span><span class=n>set</span><span class=p>(</span><span class=n>CAP_PROP_FPS</span><span class=p>,</span><span class=w> </span><span class=n>w</span><span class=p>);</span>
</code></pre></div> <p>and in the function <code>make_window(...)</code></p> <div class=highlight><pre><span></span><code><span class=c1>// before</span>
<span class=n>setWindowProperty</span><span class=p>(</span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=n>CV_WND_PROP_FULLSCREEN</span><span class=p>,</span><span class=w> </span><span class=n>CV_WINDOW_FULLSCREEN</span><span class=p>);</span>

<span class=c1>// after</span>
<span class=n>setWindowProperty</span><span class=p>(</span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=n>WND_PROP_FULLSCREEN</span><span class=p>,</span><span class=w> </span><span class=n>WINDOW_FULLSCREEN</span><span class=p>);</span>
</code></pre></div> <p>Tadah! Finally we successfully compiled darknet with CUDA and OpenCV support in Arch Linux !</p> <p>Now we can test our darknet using either</p> <div class=highlight><pre><span></span><code>./darket<span class=w> </span>imtest<span class=w> </span>data/eagle.jpg

<span class=c1># pop up an instance image</span>
</code></pre></div> <p>or</p> <div class=highlight><pre><span></span><code>./darknet<span class=w> </span>detect<span class=w> </span>cfg/yolov3.cfg<span class=w> </span>yolov3.weights<span class=w> </span>data/dog.jpg

<span class=c1># object detection of an instance image in yolov3 with [pretrained weights](https://pjreddie.com/media/files/yolov3.weights) in a rather good speed</span>
</code></pre></div> <h1>4. possible errors</h1> <h2>CUDA Error: out of memory</h2> <p>When the terminal prompts</p> <div class=highlight><pre><span></span><code><span class=mf>28</span><span class=w> </span><span class=n>conv</span><span class=w>    </span><span class=mf>128</span><span class=w>  </span><span class=mf>1</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=mf>1</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=mf>1</span><span class=w>    </span><span class=mf>76</span><span class=w> </span><span class=n>x</span><span class=w>  </span><span class=mf>76</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=mf>256</span><span class=w>   </span><span class=o>-&gt;</span><span class=w>    </span><span class=mf>76</span><span class=w> </span><span class=n>x</span><span class=w>  </span><span class=mf>76</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=mf>128</span><span class=w>  </span><span class=mf>0.379</span><span class=w> </span><span class=n>BFLOPs</span>
<span class=mf>29</span><span class=w> </span><span class=n>conv</span><span class=w>    </span><span class=mf>256</span><span class=w>  </span><span class=mf>3</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=mf>3</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=mf>1</span><span class=w>    </span><span class=mf>76</span><span class=w> </span><span class=n>x</span><span class=w>  </span><span class=mf>76</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=mf>128</span><span class=w>   </span><span class=o>-&gt;</span><span class=w>    </span><span class=mf>76</span><span class=w> </span><span class=n>x</span><span class=w>  </span><span class=mf>76</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=mf>256</span><span class=w>  </span><span class=mf>3.407</span><span class=w> </span><span class=n>BFLOPs</span>
<span class=mf>30</span><span class=w> </span><span class=n>res</span><span class=w>   </span><span class=mf>27</span><span class=w>                  </span><span class=mf>76</span><span class=w> </span><span class=n>x</span><span class=w>  </span><span class=mf>76</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=mf>256</span><span class=w>   </span><span class=o>-&gt;</span><span class=w>    </span><span class=mf>76</span><span class=w> </span><span class=n>x</span><span class=w>  </span><span class=mf>76</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=mf>256</span>
<span class=mf>31</span><span class=w> </span><span class=n>conv</span><span class=w>    </span><span class=mf>128</span><span class=w>  </span><span class=mf>1</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=mf>1</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=mf>1</span><span class=w>    </span><span class=mf>76</span><span class=w> </span><span class=n>x</span><span class=w>  </span><span class=mf>76</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=mf>256</span><span class=w>   </span><span class=o>-&gt;</span><span class=w>    </span><span class=mf>76</span><span class=w> </span><span class=n>x</span><span class=w>  </span><span class=mf>76</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=mf>128</span><span class=w>  </span><span class=mf>0.379</span><span class=w> </span><span class=n>BFLOPs</span>
<span class=mf>32</span><span class=w> </span><span class=n>CUDA</span><span class=w> </span><span class=n>Error</span><span class=p>:</span><span class=w> </span><span class=n>out</span><span class=w> </span><span class=n>of</span><span class=w> </span><span class=n>memory</span>
<span class=n>darknet</span><span class=p>:</span><span class=w> </span><span class=mf>.</span><span class=o>/</span><span class=n>src</span><span class=o>/</span><span class=n>cuda</span><span class=mf>.</span><span class=n>c</span><span class=p>:</span><span class=mf>36</span><span class=p>:</span><span class=w> </span><span class=n>check_error</span><span class=p>:</span><span class=w> </span><span class=n>Assertion</span><span class=w> </span><span class=err>`</span><span class=mf>0</span><span class=err>&#39;</span><span class=w> </span><span class=n>failed</span><span class=mf>.</span>
<span class=err>[</span><span class=mf>1</span><span class=err>]</span><span class=w>  </span><span class=mf>635531</span><span class=w> </span><span class=n>abort</span><span class=w> </span><span class=p>(</span><span class=n>core</span><span class=w> </span><span class=n>dumped</span><span class=p>)</span><span class=w>  </span><span class=mf>.</span><span class=o>/</span><span class=n>darknet</span><span class=w> </span><span class=n>detect</span><span class=w> </span><span class=n>cfg</span><span class=o>/</span><span class=n>yolov3</span><span class=mf>.</span><span class=n>cfg</span><span class=w> </span><span class=n>yolov3</span><span class=mf>.</span><span class=n>weights</span><span class=w> </span><span class=kd>data</span><span class=o>/</span><span class=n>dog</span><span class=mf>.</span><span class=n>jpg</span>
</code></pre></div> <p>indicates that you may have run out of your GPU memory.</p> <p>The solution is quite easy: decrease the number of images per batch in corresponding configuration file e.g <code>cfg/yolov3.cfg</code></p> <div class=highlight><pre><span></span><code># before
batch = 64

# after
batch = 16
</code></pre></div> <h1>5. prediction result</h1> <div class=highlight><pre><span></span><code>./darknet<span class=w> </span>detect<span class=w> </span>cfg/yolov3.cfg<span class=w> </span>yolov3.weights<span class=w> </span>data/dog.jpg
</code></pre></div> <div class=highlight><pre><span></span><code><span class=c1># output:</span>
data/dog.jpg:<span class=w> </span>Predicted<span class=w> </span><span class=k>in</span><span class=w> </span><span class=m>0</span>.719306<span class=w> </span>seconds.
dog:<span class=w> </span><span class=m>100</span>%
truck:<span class=w> </span><span class=m>92</span>%
bicycle:<span class=w> </span><span class=m>99</span>%
</code></pre></div> <p><img alt="raw image" src=/files/deploy-darknet-with-CUDA-and-OpenCV-support/dog.jpg></p> <p><img alt="predicted image" src=/files/deploy-darknet-with-CUDA-and-OpenCV-support/predictions.jpg></p> </body> </html>